<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>KBot - Trading Bot</title>
    <link rel="icon" href="{{ url_for('static', filename='logoKBot_p.png') }}">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
        }
        html { color-scheme: dark; }
        body {
            background-color: #0f172a; /* fallback */
            background-image: linear-gradient(to bottom right, #0f172a, #1e293b, #0f172a);
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 0;
        }
        .logo { height: 32px; width: auto; }

        /* Cores PNL */
        .positive-pnl { color: #22c55e; } /* text-green-500 */
        .negative-pnl { color: #ef4444; } /* text-red-500 */

        .credential-fields { display: none; }
        .toggle-indicator.open { transform: rotate(180deg); }


        /* --- INÍCIO DA MODIFICAÇÃO (CSS para Novo Painel de Logs v3) --- */

        .log-window a { text-decoration: none; }

        .log-window {
            height: 24rem; /* h-96 */
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem; /* text-xs (12px) */
            line-height: 1.4;
            /* Fundo ligeiramente mais escuro */
            background-color: #0b1120;
            border-color: #334155; /* border-slate-700 */
        }

        .log-line {
            display: flex;
            align-items: flex-start;
            padding: 4px 8px;
            /* Remover a borda inferior */
            border-bottom: none;
            transition: background-color 0.15s ease-in-out;
            word-break: break-all;
        }
        .log-line:hover {
            background-color: #1e293b; /* bg-slate-800 */
        }
        .log-line.hidden {
            display: none;
        }

        /* Cores e Ícones por Nível */
        .log-icon {
            flex-shrink: 0;
            width: 1.1rem;
            height: 1.1rem;
            margin-right: 6px;
            margin-top: 1px;
        }

        /* Cores base dos ícones */
        .log-line[data-level="INFO"] .log-icon { color: #60a5fa; } /* Azul claro */
        .log-line[data-level="SUCCESS"] .log-icon { color: #4ade80; } /* Verde claro */
        .log-line[data-level="WARNING"] .log-icon { color: #facc15; } /* Amarelo claro */
        .log-line[data-level="ERROR"] .log-icon { color: #f87171; } /* Vermelho claro */
        .log-line[data-level="DEBUG"] .log-icon { color: #c084fc; } /* Roxo claro */

        .log-timestamp {
            flex-shrink: 0;
            color: #64748b; /* text-slate-500 */
            margin-right: 8px;
        }

        /* Badge de Conta */
        .log-account-badge {
            /* Estrutura e Fonte */
            display: inline-block; /* Garante que padding funcione bem */
            padding: 1px 7px; /* Ajuste fino do padding */
            border-radius: 99px; /* Totalmente arredondado */
            font-size: 0.7rem;  /* Levemente maior que 0.65rem */
            font-weight: 500;   /* Médio, não bold */
            margin-right: 8px;
            margin-top: 1px; /* Ajuste para alinhar melhor com timestamp */
            line-height: 1.3;  /* Ajuste para centralizar texto verticalmente */
            text-transform: uppercase;
            border-width: 1px;
            border-style: solid;

            /* Cores serão definidas via JS (inline style) */
            background-color: transparent; /* Começa transparente */
            color: inherit; /* Herda cor padrão */
            border-color: transparent; /* Começa transparente */
        }

        /* Mensagem */
        .log-message {
            color: #cbd5e1; /* text-slate-300 */
            white-space: pre-wrap; /* Preserva newlines e espaços */
        }
        /* Cor da mensagem SÓ para Warning e Error */
        .log-line[data-level="WARNING"] .log-message { color: #fef08a; } /* Amarelo mais claro */
        .log-line[data-level="ERROR"] .log-message { color: #fecaca; } /* Vermelho mais claro */

        /* Highlight da busca */
        .log-message mark {
            background-color: #fde047; /* bg-yellow-300 */
            color: #1e293b;
            padding: 0 1px;
            border-radius: 2px;
        }

        /* Seção da Toolbar (controles e stats) */
        .log-toolbar-section {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem; /* gap-2 */
            align-items: center;
        }

        /* Contadores de Stats (NOVO ESTILO - v3) */
        .stat-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem; /* gap-1 */
            font-size: 0.75rem; /* text-xs */
            font-weight: 400; /* Fonte normal */
            padding: 0.2rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid;
        }
        /* Cores ajustadas (Fundo sólido escuro, Texto claro, Borda sutil) */
        .stat-badge-all { background-color: #334155; color: #cbd5e1; border-color: #475569; }
        .stat-badge-info { background-color: #1e40af; color: #93c5fd; border-color: #3b82f6; } /* Fundo: blue-800, Texto: blue-300, Borda: blue-500 */
        .stat-badge-success { background-color: #166534; color: #86efac; border-color: #22c55e; } /* Fundo: green-800, Texto: green-300, Borda: green-500 */
        .stat-badge-warning { background-color: #854d0e; color: #fde047; border-color: #eab308; } /* Fundo: amber-800, Texto: yellow-300, Borda: yellow-500 */
        .stat-badge-error { background-color: #991b1b; color: #fca5a5; border-color: #ef4444; } /* Fundo: red-800, Texto: red-300, Borda: red-500 */


        /* Controles (Botões) */
        .log-control-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem; /* gap-2 */
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            font-weight: 500;
            background-color: #334155; /* bg-slate-700 */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.15s;
            cursor: pointer;
        }
        .log-control-btn:hover {
            background-color: #475569; /* hover:bg-slate-600 */
        }
        .log-control-btn.active {
            background-color: #22c55e; /* bg-green-500 */
            color: #fff;
        }
        .log-control-btn.active:hover {
            background-color: #16a34a; /* hover:bg-green-600 */
        }
        .log-control-btn svg {
            width: 1rem; height: 1rem;
        }

        /* Inputs e Selects */
        .log-filter-input {
            width: 100%;
            background-color: #1e293b; /* bg-slate-800 */
            border: 1px solid #334155; /* border-slate-700 */
            border-radius: 0.375rem; /* rounded-lg */
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
        .log-filter-input:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
        }

        /* Animação de Status */
        .status-indicator {
            width: 0.75rem; height: 0.75rem;
            border-radius: 99px;
            background-color: #22c55e; /* bg-green-500 */
        }
        .status-indicator.paused {
            background-color: #eab308; /* bg-yellow-500 */
        }
        .status-indicator.active {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        /* --- FIM DA MODIFICAÇÃO (CSS v3) --- */

    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-gray-100 p-6">

    <div class="container">

        <div class="flex justify-between items-center mb-8 px-4 py-2">
            <div class="flex items-center gap-3">
                 <img src="{{ url_for('static', filename='logoKBot.png') }}" alt="Logo" class="logo h-8 w-auto">
                 <h1></h1>
            </div>

            <div class="header-right-side flex items-center gap-6">
                <div class="donate-section text-xs text-center">
                    <strong class="text-white font-semibold flex items-center justify-center gap-1.5 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="#ef4444" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        Donate
                    </strong>
                    <div class="donate-address flex items-center justify-end gap-2">
                        <span class="text-gray-400 font-mono">Sol: 4Lu4...FX9</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy text-blue-400 cursor-pointer" title="Copiar" onclick="copyToClipboard('4Lu4D1yD78pLVvLf8gGgH7fS7t6kmjTaWaigy72HyFX9')"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                    </div>
                    <div class="donate-address flex items-center justify-end gap-2">
                        <span class="text-gray-400 font-mono">EVM: 0x80...9E11</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy text-blue-400 cursor-pointer" title="Copiar" onclick="copyToClipboard('0x8084e7ba605ea5A802c12eF416bd571769769E11')"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                    </div>
                </div>

                <div class="version-info text-xs text-right text-gray-400 flex flex-col items-end gap-1">
                    {% if version_info and not version_info.error %}
                        <span class="font-mono">Versão: {{ version_info.local_short }}</span>
                        {% if version_info.is_latest %}
                            <span class="text-green-400 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg> Atualizado</span>
                        {% else %}
                            <a href="{{ version_info.repo_url }}" target="_blank" class="text-yellow-400 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg> Nova versão disponível
                            </a>
                        {% endif %}
                    {% elif version_info.error %}
                         <span class="text-yellow-400 flex items-center gap-1" title="{{ version_info.error }}"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> Verificação Indisponível</span>
                    {% endif %}
                    <a href="https://github.com/kb9loso/KBot-Trading/tree/main/docs" target="_blank" class="text-blue-400 font-semibold flex items-center gap-1" title="Ver Documentação">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        Docs.
                    </a>
                </div>
            </div>
        </div>

        <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8">
             <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-target w-5 h-5 text-blue-400"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                    Contas Gerenciadas
                </h2>
                <div class="flex flex-wrap gap-2">
                    <form action="/start_all" method="post" style="margin:0;"><button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition flex items-center gap-2 text-sm" title="Iniciar Todos os Bots"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play w-4 h-4"><polygon points="5 3 19 12 5 21 5 3"/></svg> Iniciar Todos</button></form>
                    <form action="/stop_all" method="post" style="margin:0;"><button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition flex items-center gap-2 text-sm" title="Parar Todos os Bots"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause w-4 h-4"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> Parar Todos</button></form>
                    <form action="/refresh_all" method="post" style="margin:0;"><button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition flex items-center gap-2 text-sm" title="Atualizar Dados"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw w-4 h-4"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M3 21v-5h5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/></svg> Atualizar</button></form>
                    <button class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition flex items-center gap-2 text-sm" onclick="toggleAddAccountForm()" title="Adicionar Nova Conta"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus w-4 h-4"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Nova Conta</button>
                    <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition flex items-center gap-2 text-sm" onclick="toggleNotificationsForm()" title="Gerenciar Notificações"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell w-4 h-4"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Notificações</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-sm text-gray-400 border-b border-slate-700">
                            <th class="pb-3 px-3">Nome da Conta</th><th class="pb-3 px-3">Exchange</th><th class="pb-3 px-3">Chave Pública</th>
                            <th class="pb-3 px-3">Intervalo</th><th class="pb-3 px-3">Status</th><th class="pb-3 px-3 text-right">Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if not accounts %}
                            <tr><td colspan="6" class="text-center py-4 text-gray-400">Nenhuma conta cadastrada.</td></tr>
                        {% endif %}
                        {% for account in accounts %}
                        <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition">
                            <td class="py-3 px-3 font-semibold">{{ account.account_name }}</td>
                            <td class="py-3 px-3 text-sm">{{ account.exchange_name | capitalize }}</td>
                            <td class="py-3 px-3 text-sm text-gray-400">
                                {% if account.exchange_name == 'pacifica' and account.main_public_key %}
                                    {{ account.main_public_key[:6] }}...{{ account.main_public_key[-4:] }}
                                {% elif account.exchange_name == 'apex' and account.zk_l2key %}
                                    {{ account.zk_l2key[:6] }}...{{ account.zk_l2key[-4:] }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="py-3 px-3 text-sm">{{ account.check_interval_seconds }}s</td>
                            <td class="py-3 px-3">
                                <span class="text-sm font-semibold px-3 py-1 rounded-full {{ 'text-green-400 bg-green-500/20' if account.account_name in running_bots else 'text-gray-400 bg-gray-500/20' }}">
                                    {{ 'Executando' if account.account_name in running_bots else 'Pausado' }}
                                </span>
                            </td>
                            <td class="py-3 px-3">
                                <div class="flex gap-2 justify-end">
                                    {% if account.account_name in running_bots %}
                                        <form action="/stop/{{ account.account_name }}" method="post" style="margin:0;"><button type="submit" class="p-2 bg-red-600/80 hover:bg-red-600 rounded-lg transition" title="Parar Bot"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause w-4 h-4"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg></button></form>
                                    {% else %}
                                        <form action="/start/{{ account.exchange_name }}/{{ account.account_name }}" method="post" style="margin:0;"><button type="submit" class="p-2 bg-green-600/80 hover:bg-green-600 rounded-lg transition" title="Iniciar Bot"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play w-4 h-4"><polygon points="5 3 19 12 5 21 5 3"/></svg></button></form>
                                    {% endif %}
                                    <button type="button" class="p-2 bg-blue-600/80 hover:bg-blue-600 rounded-lg transition" title="Editar Conta" onclick='editAccount({{ account | tojson | safe }})'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit w-4 h-4"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                                    <form action="/delete_account/{{ account.exchange_name }}/{{ account.account_name }}" method="post" style="margin:0;" onsubmit="return confirm('Remover esta conta e todos os setups?');"><button type="submit" class="p-2 bg-orange-600/80 hover:bg-orange-600 rounded-lg transition" title="Remover Conta"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 w-4 h-4"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button></form>
                                    <form action="/toggle_notifications/{{ account.exchange_name }}/{{ account.account_name }}" method="post" style="margin:0;">
                                        <button type="submit" class="p-2 bg-indigo-600/80 hover:bg-indigo-600 rounded-lg transition"
                                                title="{{ 'Desativar' if account.notifications_enabled else 'Ativar' }} notificações"
                                                {{ 'disabled' if not telegram_config.enabled }}>
                                            {% if account.notifications_enabled %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell w-4 h-4"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                                            {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell-off w-4 h-4"><path d="M13.73 21a2 2 0 0 1-3.46 0"/><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="m2 2 20 20"/></svg>
                                            {% endif %}
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-section bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8" id="add-account-section" style="display: none;">
            <h2 id="account-form-title" class="text-xl font-bold flex items-center gap-2 mb-6">Adicionar Nova Conta</h2>
            <form id="account-form" action="/manage_account" method="post" onsubmit="return validateAccountForm()" class="space-y-6">
                <input type="hidden" name="original_account_name" id="original_account_name">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label title="Um nome único para identificar esta conta no painel." class="block">
                        <span class="block text-sm font-medium text-gray-300 mb-2">Nome da Conta</span>
                        <input type="text" name="account_name" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                    </label>
                    <label title="A corretora onde esta conta será usada." class="block">
                        <span class="block text-sm font-medium text-gray-300 mb-2">Exchange</span>
                        <select name="exchange_name" required onchange="toggleCredentialFields(this.value)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                            {% for ex_name in exchanges_allowed %}
                            <option value="{{ ex_name }}">{{ ex_name | capitalize }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label title="O intervalo em segundos que o bot aguardará entre cada verificação de sinais de trading." class="block">
                        <span class="block text-sm font-medium text-gray-300 mb-2">Intervalo (s)</span>
                        <input type="number" name="check_interval" value="180" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                    </label>
                </div>
                <div id="pacifica-fields" class="credential-fields space-y-4">
                    <label title="A chave de API pública da sua conta na exchange." class="block"><span class="block text-sm font-medium text-gray-300 mb-2">Chave Pública</span><input type="text" name="main_public_key" class="pacifica-required w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500"></label>
                    <label title="A chave de API privada (secret key) da sua conta na exchange." class="block"><span class="block text-sm font-medium text-gray-300 mb-2">Chave Privada do Agente</span><input type="password" name="agent_private_key" class="pacifica-required w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500"></label>
                </div>
                <div id="apex-fields" class="credential-fields space-y-4">
                    <label title="Sua API Key da Apex." class="block"><span class="block text-sm font-medium text-gray-300 mb-2">API Key</span><input type="text" name="api_key" class="apex-required w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500"></label>
                    <label title="Seu API Secret da Apex." class="block"><span class="block text-sm font-medium text-gray-300 mb-2">API Secret</span><input type="password" name="api_secret" class="apex-required w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500"></label>
                    <label title="Sua API Passphrase da Apex." class="block"><span class="block text-sm font-medium text-gray-300 mb-2">API Passphrase</span><input type="password" name="passphrase" class="apex-required w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500"></label>
                    <label title="Sua ZK Seed da Apex." class="block"><span class="block text-sm font-medium text-gray-300 mb-2">ZK Seeds</span><input type="password" name="zk_seeds" class="apex-required w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500"></label>
                    <label title="Sua ZK L2 Key da Apex." class="block"><span class="block text-sm font-medium text-gray-300 mb-2">ZK L2 Key</span><input type="password" name="zk_l2key" class="apex-required w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500"></label>
                </div>
                <div class="flex gap-3 justify-end pt-4 border-t border-slate-700">
                    <button type="button" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition" onclick="toggleAddAccountForm()">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Salvar Conta</button>
                </div>
            </form>
        </div>

        <div class="form-section bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8" id="notifications-section" style="display: none;">
            <h2 class="text-xl font-bold flex items-center gap-2 mb-6">Gerenciar Notificações do Telegram</h2>
            <form action="/save_telegram_settings" method="post" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label title="Token do seu bot do Telegram, obtido com o @BotFather." class="block">
                        <span class="block text-sm font-medium text-gray-300 mb-2">Token do Bot</span>
                        <input type="text" name="telegram_bot_token" value="{{ telegram_config.bot_token or '' }}" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                    </label>
                    <label title="ID do chat para onde as notificações serão enviadas." class="block">
                        <span class="block text-sm font-medium text-gray-300 mb-2">Chat ID</span>
                        <input type="text" name="telegram_chat_id" value="{{ telegram_config.chat_id or '' }}" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                    </label>
                </div>
                <div class="flex gap-6">
                    <label title="Notificar no Telegram quando uma posição for aberta." class="flex items-center gap-2 text-sm font-medium text-gray-300"><input type="checkbox" name="notify_on_open" value="true" {{ 'checked' if telegram_config.get('notify_on_open') }} class="bg-slate-700 border-slate-600 rounded focus:ring-blue-500">Notificar Abertura</label>
                    <label title="Notificar no Telegram quando uma posição for fechada." class="flex items-center gap-2 text-sm font-medium text-gray-300"><input type="checkbox" name="notify_on_close" value="true" {{ 'checked' if telegram_config.get('notify_on_close') }} class="bg-slate-700 border-slate-600 rounded focus:ring-blue-500">Notificar Fechamento</label>
                </div>
                <div class="flex gap-3 justify-end pt-4 border-t border-slate-700">
                    <button type="button" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition" onclick="toggleNotificationsForm()">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Salvar Configurações</button>
                </div>
            </form>
        </div>

        {% if accounts %}
            <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity w-5 h-5 text-purple-400"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                        Visão Geral
                    </h2>
                    <form id="account-filter-form" action="{{ url_for('index') }}" method="get" style="margin:0;">
                        <label class="flex items-center gap-3">
                            <span class="text-sm text-gray-400">Exibir dados para:</span>
                            <select name="account" onchange="this.form.submit()" class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-slate-600">
                                <option value="all" {% if selected_account_filter == 'all' %}selected{% endif %}>Todas as Contas</option>
                                {% for acc in accounts %}
                                    <option value="{{ acc.account_name }}" {% if selected_account_filter == acc.account_name %}selected{% endif %}>
                                        {{ acc.account_name }} ({{ acc.exchange_name | capitalize }})
                                    </option>
                                {% endfor %}
                            </select>
                        </label>
                    </form>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {% if account_info and account_info.account_equity is defined %}
                        {% if volume_7d is defined and volume_7d > 0 %}
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-3"><span class="text-sm text-gray-400">VOLUME (7D)</span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw w-5 h-5 text-gray-400"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M3 21v-5h5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/></svg></div>
                            <div class="text-3xl font-bold">${{ "%.2f"|format(volume_7d|float) }}</div>
                        </div>
                        {% endif %}
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-3"><span class="text-sm text-gray-400">PATRIMÔNIO</span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up w-5 h-5 text-gray-400"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg></div>
                            <div class="text-3xl font-bold">${{ "%.2f"|format(account_info.account_equity|float) }}</div>
                        </div>
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 cursor-pointer" onclick="togglePositionsTable()">
                            <div class="flex items-center justify-between mb-3"><span class="text-sm text-gray-400">POSIÇÕES</span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box w-5 h-5 text-gray-400"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/></svg></div>
                            <div class="flex items-center justify-between"><span class="text-3xl font-bold">{{ open_positions_details | length }}</span><svg id="positions-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down w-5 h-5 text-gray-400 toggle-indicator transition-transform duration-200"><path d="m6 9 6 6 6-6"/></svg></div>
                        </div>
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-3"><span class="text-sm text-gray-400">DISPONÍVEL</span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign w-5 h-5 text-gray-400"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                            <div class="text-3xl font-bold">${{ "%.2f"|format(account_info.available_to_spend|float) }}</div>
                        </div>
                    {% else %}
                        <div class="col-span-full text-center text-gray-400 py-4">Clique em "Atualizar Dados" para carregar as informações.</div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8" id="positions-section" style="display: none;">
                 <h2 class="text-xl font-bold flex items-center gap-2 mb-6">Posições Abertas</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-sm text-gray-400 border-b border-slate-700">
                                <th class="pb-3 px-3">Conta</th><th class="pb-3 px-3">Ativo</th><th class="pb-3 px-3">Lado</th><th class="pb-3 px-3">Quantidade</th>
                                <th class="pb-3 px-3">Preço Entrada</th><th class="pb-3 px-3">Preço Atual</th><th class="pb-3 px-3">% PnL</th>
                                <th class="pb-3 px-3">SL / TP</th><th class="pb-3 px-3">Data Criação (UTC)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pos in open_positions_details %}
                            <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition">
                                <td class="py-3 px-3">{{ pos.account_name }}</td><td class="py-3 px-3">{{ pos.symbol }}</td>
                                <td class="py-3 px-3"><span class="{{ 'text-green-400' if pos.side == 'bid' else 'text-red-400' }}">{{ 'Long' if pos.side == 'bid' else 'Short' }}</span></td>
                                <td class="py-3 px-3">{{ pos.amount | float }}</td><td class="py-3 px-3">${{ pos.entry_price|float }}</td><td class="py-3 px-3">${{ pos.current_price|float }}</td>
                                <td class="py-3 px-3 {{ 'text-green-400' if pos.pnl_percentage >= 0 else 'text-red-400' }}">{{ "%+.2f"|format(pos.pnl_percentage) }}%</td>
                                <td class="py-3 px-3">${{ pos.sl_price|float if pos.sl_price != 'N/A' else '-' }} / ${{ pos.tp_price|float if pos.tp_price != 'N/A' else '-' }}</td>
                                <td class="py-3 px-3">{{ pos.creation_date_utc }}</td>
                            </tr>
                            {% else %}<tr><td colspan="9" class="text-center py-4 text-gray-400">Nenhuma posição aberta.</td></tr>{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8">
                <h2 class="text-xl font-bold flex items-center gap-2 mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-target w-5 h-5 text-green-400"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                    Performance (Últimos 30 Dias)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    {% if dashboard and dashboard.total_trades > 0 %}
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign w-6 h-6 {{ 'text-green-400' if dashboard.total_pnl >= 0 else 'text-red-400' }}"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><span class="text-sm text-gray-400">PNL TOTAL</span></div>
                            <div class="text-2xl font-bold {{ 'text-green-400' if dashboard.total_pnl >= 0 else 'text-red-400' }}">${{ "%.2f"|format(dashboard.total_pnl) }}</div>
                        </div>
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw w-6 h-6 text-blue-400"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M3 21v-5h5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/></svg><span class="text-sm text-gray-400">TRADES</span></div>
                            <div class="text-2xl font-bold">{{ dashboard.total_trades }}</div>
                        </div>
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-target w-6 h-6 text-purple-400"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg><span class="text-sm text-gray-400">ACERTO</span></div>
                            <div class="text-2xl font-bold">{{ "%.1f"|format(dashboard.win_rate) }}%</div>
                        </div>
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up w-6 h-6 text-green-400"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg><span class="text-sm text-gray-400">GANHO MÉDIO</span></div>
                            <div class="text-2xl font-bold text-green-400">${{ "%.2f"|format(dashboard.avg_win) }}</div>
                        </div>
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-down w-6 h-6 text-red-400"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg><span class="text-sm text-gray-400">PERDA MÉDIA</span></div>
                            <div class="text-2xl font-bold text-red-400">${{ "%.2f"|format(dashboard.avg_loss) }}</div>
                        </div>
                        <div class="bg-slate-800 border border-slate-700 rounded-xl p-5">
                            <div class="flex items-center gap-3 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle w-6 h-6 text-yellow-400"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span class="text-sm text-gray-400">TAXAS</span></div>
                            <div class="text-2xl font-bold">${{ "%.2f"|format(dashboard.total_fees) }}</div>
                        </div>
                    {% else %}
                        <div class="col-span-full text-center text-gray-400 py-4">Nenhum histórico de trades encontrado.</div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks w-5 h-5 text-purple-400"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></svg>
                        Setups Ativos
                    </h2>
                    <button onclick="showSetupForm(null)" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition flex items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus w-4 h-4"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Adicionar Setup
                    </button>
                </div>

                <div class="space-y-3">
                    {% if not accounts %}
                        <div class="text-center text-gray-400 py-4">Nenhuma conta cadastrada.</div>
                    {% endif %}

                    {% for account in accounts %}
                        {% set account_id_safe = account.account_name | replace(' ', '-') | lower %}

                        {% set total_setup_count = namespace(value=0) %}
                        {% set open_position_setup_count = namespace(value=0) %}
                        {% set account_open_positions = open_positions_by_account.get(account.account_name, []) %}

                        {% for market in setups_to_display if market.account_name == account.account_name %}
                            {% set total_setup_count.value = total_setup_count.value + 1 %}
                            {# Verifica se o base_currency deste setup está na lista de ativos com posição aberta para esta conta #}
                            {% if market.base_currency in account_open_positions %}
                                {% set open_position_setup_count.value = open_position_setup_count.value + 1 %}
                            {% endif %}
                        {% endfor %}
                        <button
                            onclick="toggleSetups('setups-content-{{ account_id_safe }}', 'setups-icon-{{ account_id_safe }}')"
                            class="w-full flex items-center justify-between bg-slate-700/50 px-4 py-3 rounded-lg hover:bg-slate-700/70 transition"
                        >
                            <div class="flex flex-wrap items-center gap-3">
                                <span class="font-bold text-lg">{{ account.account_name }}</span>
                                <span class="text-sm text-gray-400 px-2 py-1 bg-slate-800 rounded">
                                    {{ total_setup_count.value }} Setups
                                </span>
                                <span class="text-sm font-semibold px-2 py-1 rounded {{ 'bg-green-500/20 text-green-400' if open_position_setup_count.value > 0 else 'bg-gray-500/20 text-gray-400' }}">
                                    {{ open_position_setup_count.value }} Posições Abertas
                                </span>
                            </div>
                            <svg id="setups-icon-{{ account_id_safe }}" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up w-5 h-5 transition-transform duration-200"><path d="m18 15-6-6-6 6"/></svg>
                        </button>

                        <div id="setups-content-{{ account_id_safe }}" class="overflow-x-auto p-0 transition-all duration-300" style="display: none;"> {# Começa escondido com style.display #}
                            <table class="w-full">
                                <thead>
                                   <tr class="text-left text-xs text-gray-400 border-b border-slate-700">
                                        <th class="pb-3 px-3">Ativo</th>
                                        <th class="pb-3 px-3">Estratégia</th>
                                        <th class="pb-3 px-3">Alav.</th>
                                        <th class="pb-3 px-3">Risco/Trade</th>
                                        <th class="pb-3 px-3">Stop Loss</th>
                                        <th class="pb-3 px-3">Take Profit</th>
                                        <th class="pb-3 px-3">Modo Saída</th>
                                        <th class="pb-3 px-3">Direção</th>
                                        <th class="pb-3 px-3">Trailing</th>
                                        <th class="pb-3 px-3 text-right">Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if total_setup_count.value == 0 %}
                                        <tr><td colspan="10" class="text-center py-4 text-gray-400">Nenhum setup cadastrado para este bot.</td></tr>
                                    {% endif %}

                                    {% for market in setups_to_display if market.account_name == account.account_name %}
                                    <tr class="border-b border-slate-700/50 hover:bg-slate-700/30 transition">
                                        <td class="py-3 px-3">
                                            <div class="flex items-center gap-2">
                                                <span class="w-2 h-2 rounded-full {{ 'bg-green-400' if market.base_currency in account_open_positions else 'bg-gray-400' }}"></span>
                                                <span class="font-semibold">{{ market.base_currency }}</span>
                                            </div>
                                        </td>
                                        <td class="py-3 px-3 text-sm">{{ market.strategy_name }}</td>
                                        <td class="py-3 px-3 text-sm">{{ market.leverage }}x</td>
                                        <td class="py-3 px-3 text-sm">{{ "%.2f"|format(market.risk_per_trade * 100) }}%</td>
                                        <td class="py-3 px-3 text-sm">{{ "%.2f"|format(market.stop_loss_config.value * 100) ~ '%' if market.stop_loss_config.type == 'percentage' else market.stop_loss_config.value ~ 'x ATR' }}</td>
                                        <td class="py-3 px-3 text-sm">{{ market.take_profit_rrr }}:1 RRR</td>
                                        <td class="py-3 px-3 text-sm">
                                            <span class="text-xs px-2 py-1 rounded {{ 'bg-green-500/20 text-green-400' if market.exit_mode == 'ativo' else 'bg-gray-500/20 text-gray-400' }}">
                                                {{ market.exit_mode | capitalize }}
                                            </span>
                                        </td>
                                        <td class="py-3 px-3 text-sm">
                                            {{ 'Long & Short' if market.direction_mode == 'long_short'
                                            else 'Long Only' if market.direction_mode == 'long_only'
                                            else 'Short Only' if market.direction_mode == 'short_only'
                                            else 'BTC Trend' }}
                                        </td>
                                        <td class="py-3 px-3 text-sm">
                                            {% set tsl = market.trailing_stop_config %}
                                            {% if tsl and tsl.type != 'none' %}
                                                {% if tsl.type == 'breakeven' %}
                                                    BEP ({{ "%.1f"|format(tsl.breakeven_trigger_rrr) }} RRR)
                                                {% else %}
                                                    {{ tsl.type|upper }}
                                                {% endif %}
                                            {% else %}
                                                Nenhum
                                            {% endif %}
                                        </td>
                                        <td class="py-3 px-3">
                                            <div class="flex gap-1 justify-end">
                                                <button type="button" class="p-1.5 bg-slate-600 hover:bg-slate-500 rounded transition" title="Editar Setup" onclick='showSetupForm({{ market | tojson | safe }})'><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit w-3.5 h-3.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                                                <form action="/delete_market/{{ market.account_name }}/{{ market.id }}" method="post" style="margin:0;" onsubmit="return confirm('Remover este setup?');"><button type="submit" class="p-1.5 bg-red-600/80 hover:bg-red-600 rounded transition" title="Remover Setup"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 w-3.5 h-3.5"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button></form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-section bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8" id="add-setup-form-section" style="display: none;">
                <h2 class="text-xl font-bold flex items-center gap-2 mb-6">Adicionar/Atualizar Setup</h2>
                <form id="setup-form" action="/process_setup_form" method="post" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <label title="Selecione a conta de negociação para associar este setup." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">Conta</span>
                            <select name="account_name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                                {% for acc in accounts %}<option value="{{ acc.account_name }}">{{ acc.account_name }}</option>{% endfor %}
                            </select>
                        </label>
                        <label title="O símbolo do ativo a ser negociado (ex: BTC, ETH, SOL)." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">Ativo</span>
                            <input type="text" name="base_currency" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                        </label>
                        <label title="Percentual do capital total da conta a ser arriscado em cada trade." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">Risco (%)</span>
                            <input type="number" name="risk" value="1.0" step="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                        </label>
                        <label title="Fator de multiplicação da sua posição (ex: 10x, 20x)." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">Alavancagem</span>
                            <input type="number" name="leverage" value="10" step="1" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                        </label>
                        <label title="Define se o bot pode abrir posições compradas (Long), vendidas (Short) ou ambas." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">Direção</span>
                            <select name="direction_mode" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                                <option value="long_short">Long & Short</option><option value="long_only">Long Only</option><option value="short_only">Short Only</option><option value="btc_trend">BTC Trend</option>
                            </select>
                        </label>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label title="A lógica de trading que o bot usará para decidir quando entrar e sair das operações." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">Estratégia</span>
                            <select name="strategy_name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                                {% for name in strategy_names %}<option value="{{ name }}">{{ name }}</option>{% endfor %}
                            </select>
                        </label>
                        <label title="O valor percentual para o Stop Loss." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">Valor SL (%)</span>
                            <input type="number" name="sl_value" value="2.0" step="0.01" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                        </label>
                        <label title="A relação Risco/Retorno para o Take Profit. Um valor de 2.0 significa que o alvo de lucro é o dobro da distância do stop loss." class="block">
                            <span class="block text-sm font-medium text-gray-300 mb-2">TP (RRR)</span>
                            <input type="number" name="rrr" value="2.0" step="0.1" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                        </label>
                    </div>
                    <div class="flex flex-wrap items-end gap-4">
                         <label title="'Passivo' usa apenas SL/TP. 'Ativo' permite que a estratégia feche a posição se o sinal reverter." class="block">
                             <span class="block text-sm font-medium text-gray-300 mb-2">Modo Saída</span>
                             <select name="exit_mode" onchange="toggleTslSection(this.value)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                                <option value="passivo">Passivo</option><option value="ativo">Ativo</option>
                            </select>
                         </label>
                        <div id="tsl-section" style="display:none;" class="flex flex-wrap items-end gap-4">
                            <label title="Um stop loss que se move a favor do preço para proteger os lucros." class="block">
                                <span class="block text-sm font-medium text-gray-300 mb-2">Trailing Stop</span>
                                <select name="tsl_type" onchange="toggleTslOptions(this.value)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                                    <option value="none">Nenhum</option><option value="breakeven">Break-Even Point</option><option value="atr">ATR Trailing</option>
                                </select>
                            </label>
                            <div id="tsl-breakeven-options" style="display:none;" class="block">
                                <label title="(Breakeven) Relação Risco/Retorno que, ao ser atingida, move o Stop Loss para o preço de entrada.">
                                    <span class="block text-sm font-medium text-gray-300 mb-2">Acionar em (RRR)</span>
                                    <input type="number" name="tsl_breakeven_trigger" value="1.0" step="0.1" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-gray-100 focus:outline-none focus:border-blue-500">
                                </label>
                            </div>
                            <div id="tsl-atr-options" style="display:none;"></div>
                            <label title="Se marcado, o Take Profit original é removido quando o Trailing Stop é ativado." class="flex items-center gap-2 text-sm font-medium text-gray-300 pb-2">
                                <input type="checkbox" name="remove_tp_on_trail" value="true" class="bg-slate-700 border-slate-600 rounded focus:ring-blue-500">Remover TP
                            </label>
                        </div>
                    </div>
                     <div class="flex gap-3 justify-end pt-4 border-t border-slate-700">
                        <button type="button" onclick="hideSetupForm()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition">Cancelar</button>
                        <button type="submit" name="action" value="run_backtest" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg transition">Rodar Backtest</button>
                        <button type="submit" name="action" value="add_market" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">Adicionar/Atualizar</button>
                    </div>
                </form>

                {% if backtest_result and last_backtest_symbol and backtest_result.get(last_backtest_symbol) %}
                {% set result = backtest_result[last_backtest_symbol] %}
                <div class="backtest-result mt-6 border-t border-slate-700 pt-6">
                    <div class="flex items-center gap-3 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-line-chart w-5 h-5 text-purple-400"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                        <span class="text-lg font-semibold">Melhor Resultado para <strong>{{ last_backtest_symbol }}</strong></span>
                    </div>
                    <div class="text-sm text-gray-300 mb-4"><p><strong>Estratégia:</strong> {{ result['Estratégia'] }}</p><p><strong>Parâmetros:</strong> SL {{ result['Stop Loss %'] }} / TP {{ result['Take Profit RRR'] }}</p></div>
                    <div class="grid grid-cols-3 gap-4 text-center mb-4">
                        <div class="bg-slate-700 p-3 rounded-lg"><span class="block text-xs text-gray-400 uppercase">Trades</span><span class="text-xl font-bold">{{ result['Total de Trades'] }}</span></div>
                        <div class="bg-slate-700 p-3 rounded-lg"><span class="block text-xs text-gray-400 uppercase">Retorno Total</span><span class="text-xl font-bold {{ 'text-green-400' if result['Retorno %'] >= 0 else 'text-red-400' }}">{{ "%+.2f"|format(result['Retorno %']) }}%</span></div>
                        <div class="bg-slate-700 p-3 rounded-lg"><span class="block text-xs text-gray-400 uppercase">Acerto Total</span><span class="text-xl font-bold">{{ "%.1f"|format(result['Taxa de Acerto %']) }}%</span></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-sm text-gray-400 border-b border-slate-600">
                                    <th class="pb-2 px-3">Direção</th><th class="pb-2 px-3">Trades</th><th class="pb-2 px-3">Retorno</th><th class="pb-2 px-3">Acerto</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr class="border-b border-slate-700/50">
                                    <td class="py-2 px-3 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up text-green-400"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg> Long</td>
                                    <td class="py-2 px-3">{{ result['Long Trades'] }}</td>
                                    <td class="py-2 px-3 font-semibold {{ 'text-green-400' if result['Long Return %'] >= 0 else 'text-red-400' }}">{{ "%+.2f"|format(result['Long Return %']) }}%</td>
                                    <td class="py-2 px-3">{{ "%.1f"|format(result['Long Win Rate %']) }}%</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-3 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-down text-red-400"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg> Short</td>
                                    <td class="py-2 px-3">{{ result['Short Trades'] }}</td>
                                    <td class="py-2 px-3 font-semibold {{ 'text-green-400' if result['Short Return %'] >= 0 else 'text-red-400' }}">{{ "%+.2f"|format(result['Short Return %']) }}%</td>
                                    <td class="py-2 px-3">{{ "%.1f"|format(result['Short Win Rate %']) }}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
             <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8 text-center">
                <h2 class="text-xl font-bold mb-2">Nenhuma conta configurada</h2>
                <p class="text-gray-400">Adicione uma conta para começar.</p>
            </div>
        {% endif %}

        <div class="logs-section bg-slate-800/50 backdrop-blur border border-slate-700 rounded-xl p-6 mb-8">

            <div class="flex flex-wrap justify-between items-center gap-4 mb-4 pb-4 border-b border-slate-700">
                <div class="flex flex-wrap items-center gap-4">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-terminal"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                        Logs
                    </h2>
                    <div class="log-toolbar-section" id="log-stats-counters">
                        <span class="stat-badge stat-badge-all" title="Total de logs">
                            ALL <span id="log-count-all">0</span>
                        </span>
                        <span class="stat-badge stat-badge-info" title="Logs de Informação">
                            INFO <span id="log-count-info">0</span>
                        </span>
                        <span class="stat-badge stat-badge-success" title="Logs de Sucesso">
                            OK <span id="log-count-success">0</span>
                        </span>
                        <span class="stat-badge stat-badge-warning" title="Logs de Aviso">
                            WARN <span id="log-count-warning">0</span>
                        </span>
                        <span class="stat-badge stat-badge-error" title="Logs de Erro">
                            ERR <span id="log-count-error">0</span>
                        </span>
                    </div>
                </div>

                <div class="log-toolbar-section justify-start md:justify-end">
                    <button id="log-autoscroll-btn" class="log-control-btn active" title="Rolar Automaticamente">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
                        <span>Auto-Scroll</span>
                    </button>
                    <button id="log-pause-btn" class="log-control-btn" title="Pausar/Retomar Logs">
                        <svg id="log-pause-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                        <svg id="log-play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        <span id="log-pause-text">Pausar</span>
                    </button>
                    <button id="log-copy-btn" class="log-control-btn" title="Copiar logs filtrados">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    </button>
                    <button id="log-download-btn" class="log-control-btn" title="Baixar logs filtrados (.txt)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </button>
                    <button id="log-clear-btn" class="log-control-btn" title="Limpar logs da tela">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                </div>
            </div>

            <div class="flex flex-wrap md:flex-nowrap items-center gap-2 mb-4">
                <div class="relative w-full md:w-1/2">
                    <div class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none">
                        <svg class="w-4 h-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    </div>
                    <input type="text" id="log-search-input" placeholder="Buscar nos logs..." class="log-filter-input pl-8">
                </div>
                <select id="log-level-filter" class="log-filter-input w-full md:w-auto flex-1">
                    <option value="ALL">Nível: TODOS</option>
                    <option value="INFO">Nível: INFO</option>
                    <option value="SUCCESS">Nível: SUCCESS</option>
                    <option value="WARNING">Nível: WARNING</option>
                    <option value="ERROR">Nível: ERROR</option>
                    <option value="DEBUG">Nível: DEBUG</option>
                </select>
                <select id="log-account-filter" class="log-filter-input w-full md:w-auto flex-1">
                    <option value="ALL">Conta: TODAS</option>
                </select>
            </div>

            <div id="log-window" class="log-window w-full overflow-y-auto rounded-lg p-2 border">
                </div>

            <div id="log-no-results" class="text-center py-10 text-slate-400" style="display: none;">
                Nenhum log encontrado para os filtros aplicados.
            </div>

            <div class="flex justify-between items-center mt-3 text-sm text-slate-400">
                <div class="flex items-center gap-2">
                    <div id="log-status-indicator" class="status-indicator active"></div>
                    <span id="log-status-text">Conectando...</span>
                </div>
                <div>
                    Exibindo <strong id="log-count-showing" class="text-slate-200">0</strong> de <strong id="log-count-total" class="text-slate-200">0</strong> logs
                </div>
            </div>
        </div>
        </div>

    <script>
        // --- LOG PANEL LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- Estado Global dos Logs ---
            let allLogs = []; // Histórico completo recebido + novos logs
            let filteredLogs = []; // Logs atualmente visíveis após filtros
            let isPaused = false;
            let isAutoScroll = true;
            const accountColors = {}; // Armazena cores por nome de conta/logger
            const colorPalette = [ // Cores para os badges de conta
                '#3b82f6', '#22c55e', '#eab308', '#ef4444', '#a855f7', '#ec4899', '#14b8a6', '#f97316', '#64748b'
            ];
            let colorIndex = 0;
            const MAX_LOGS_DISPLAY = 500; // Limite de linhas no DOM para performance

            // --- Referências de DOM ---
            const logWindow = document.getElementById('log-window');
            const noResultsMsg = document.getElementById('log-no-results');
            // Contadores
            const countAll = document.getElementById('log-count-all');
            const countInfo = document.getElementById('log-count-info');
            const countSuccess = document.getElementById('log-count-success');
            const countWarning = document.getElementById('log-count-warning');
            const countError = document.getElementById('log-count-error');
            // Filtros
            const searchInput = document.getElementById('log-search-input');
            const levelFilter = document.getElementById('log-level-filter');
            const accountFilter = document.getElementById('log-account-filter');
            // Controles
            const autoScrollBtn = document.getElementById('log-autoscroll-btn');
            const pauseBtn = document.getElementById('log-pause-btn');
            const pauseIcon = document.getElementById('log-pause-icon');
            const playIcon = document.getElementById('log-play-icon');
            const pauseText = document.getElementById('log-pause-text');
            const copyBtn = document.getElementById('log-copy-btn');
            const downloadBtn = document.getElementById('log-download-btn');
            const clearBtn = document.getElementById('log-clear-btn');
            // Status Footer
            const statusIndicator = document.getElementById('log-status-indicator');
            const statusText = document.getElementById('log-status-text');
            const countShowing = document.getElementById('log-count-showing');
            const countTotal = document.getElementById('log-count-total');

            // --- INÍCIO DA MODIFICAÇÃO (Popular Filtro Estático e Definir Cores) ---
            // Pega a variável 'accounts' passada pelo Flask/Jinja2
            const registeredAccountsData = {{ accounts | tojson | safe }};
            const accountNames = registeredAccountsData.map(acc => acc.account_name).sort(); // Extrai e ordena os nomes

            // Limpa o filtro (exceto a opção "TODAS") e popula com contas cadastradas
            accountFilter.innerHTML = '<option value="ALL">Conta: TODAS</option>'; // Garante que começa limpo
            const accountFragment = document.createDocumentFragment();
            accountNames.forEach(accName => {
                 const option = document.createElement('option');
                 option.value = accName;
                 option.textContent = accName;
                 accountFragment.appendChild(option);

                 // Define a cor para o badge desta conta
                 if (!accountColors[accName]) {
                      accountColors[accName] = colorPalette[colorIndex % colorPalette.length];
                      colorIndex++;
                 }
            });
            accountFilter.appendChild(accountFragment); // Adiciona todas as opções de uma vez

            // Define cores para loggers internos (para que os badges funcionem)
             ['Sistema', 'Backtester', 'werkzeug', 'socketio', 'engineio'].forEach(internalName => {
                 if (!accountColors[internalName]) {
                      accountColors[internalName] = colorPalette[colorIndex % colorPalette.length];
                      colorIndex++;
                 }
             });
            // --- FIM DA MODIFICAÇÃO ---


            // --- Conexão SocketIO ---
            const socket = io();

            socket.on('connect', () => {
                console.log('Socket.IO Conectado!');
                statusIndicator.classList.add('active');
                statusIndicator.classList.remove('paused');
            });

            socket.on('disconnect', () => {
                console.warn('Socket.IO Desconectado!');
                statusText.textContent = 'Desconectado. Tentando reconectar...';
                statusIndicator.classList.remove('active');
                statusIndicator.classList.add('paused');
            });

            socket.on('initial_logs', (initialLogs) => {
                console.log(`Recebido histórico de ${initialLogs.length} logs.`);
                allLogs = initialLogs;

                // Apenas garante que os filtros estejam resetados ao carregar
                // O filtro de conta já foi populado estaticamente
                accountFilter.value = 'ALL';
                levelFilter.value = 'ALL';
                searchInput.value = '';

                renderLogs(); // Renderiza o histórico com os filtros resetados
                statusText.textContent = 'Conectado. Logs ativos.';
            });

            socket.on('new_log', (log) => {
                allLogs.push(log);
                 // Garante que a cor seja definida se for uma conta/logger novo (embora não adicione ao filtro)
                 if (log.account && !accountColors[log.account]) {
                     accountColors[log.account] = colorPalette[colorIndex % colorPalette.length];
                     colorIndex++;
                 }

                if (!isPaused) {
                    const isVisible = isLogVisible(log, searchInput.value, levelFilter.value, accountFilter.value);
                    if (isVisible) {
                        appendLogLine(log);
                        limitDOMLogs();
                    }
                    updateCounters();
                    updateFooterStats();
                } else {
                    updateCounters();
                    updateFooterStats();
                }
            });

            // --- Funções Principais ---

            function renderLogs() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedLevel = levelFilter.value;
                const selectedAccount = accountFilter.value; // Lê o valor SELECIONADO ATUALMENTE

                filteredLogs = allLogs.filter(log => isLogVisible(log, searchTerm, selectedLevel, selectedAccount));
                const logsToDisplay = filteredLogs.slice(-MAX_LOGS_DISPLAY);

                logWindow.innerHTML = '';

                if (logsToDisplay.length > 0) {
                    const fragment = document.createDocumentFragment();
                    logsToDisplay.forEach(log => {
                        fragment.appendChild(createLogLineElement(log));
                    });
                    logWindow.appendChild(fragment);
                    logWindow.style.display = 'block';
                    noResultsMsg.style.display = 'none';
                } else if (allLogs.length > 0) {
                    logWindow.style.display = 'none';
                    noResultsMsg.style.display = 'block';
                } else {
                    logWindow.style.display = 'block';
                    noResultsMsg.style.display = 'none';
                }

                updateCounters();
                updateFooterStats(logsToDisplay.length);
                // Não chama scrollToBottom aqui diretamente, deixa limitDOMLogs cuidar disso
            }

            function appendLogLine(log) {
                if (searchInput.value) { // Se busca ativa, renderLogs já trata
                     renderLogs(); // Re-renderiza para aplicar highlight e limite
                     return;
                }

                logWindow.style.display = 'block';
                noResultsMsg.style.display = 'none';

                const logElement = createLogLineElement(log);
                logWindow.appendChild(logElement);
            }

            function limitDOMLogs() {
                let logsRemoved = 0;
                // Só remove se não estiver buscando
                // E só remove se o número de filhos EXCEDER o limite
                while (logWindow.childElementCount > MAX_LOGS_DISPLAY && !searchInput.value) {
                     if(logWindow.firstChild) { // Checa se existe antes de remover
                         logWindow.removeChild(logWindow.firstChild);
                         logsRemoved++;
                     } else {
                         break; // Sai do loop se não houver mais filhos
                     }
                }

                updateFooterStats(); // Atualiza contagem exibida

                // Scroll só se autoscroll estiver ativo
                if (isAutoScroll) {
                    scrollToBottom();
                }
            }


            function createLogLineElement(log) {
                const line = document.createElement('div');
                line.className = 'log-line';
                line.dataset.level = log.level;

                const icon = getLevelIcon(log.level);
                const timestamp = `<span class="log-timestamp">${log.timestamp}</span>`;
                const badge = getAccountBadge(log.account);

                const searchTerm = searchInput.value;
                let message = log.is_html ? log.message : escapeHTML(log.message || '');

                if (searchTerm && !log.is_html && message) {
                    try {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = message;
                        const textNodes = getTextNodes(tempDiv);
                        const regex = new RegExp(escapeRegExp(searchTerm), 'gi');

                        textNodes.forEach(node => {
                            const parent = node.parentNode;
                            if (!parent) return; // Adiciona checagem de segurança
                            const text = node.nodeValue;
                            let lastIndex = 0;
                            let match;
                            const fragment = document.createDocumentFragment();

                            while ((match = regex.exec(text)) !== null) {
                                fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
                                const mark = document.createElement('mark');
                                mark.textContent = match[0];
                                fragment.appendChild(mark);
                                lastIndex = regex.lastIndex;
                            }
                            fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                             // Verifica se o nó ainda pertence ao pai antes de substituir
                            if (node.parentNode === parent) {
                                parent.replaceChild(fragment, node);
                            }
                        });
                        message = tempDiv.innerHTML;
                    } catch (e) {
                         console.error("Erro no regex de highlight:", e);
                    }
                }

                line.innerHTML = `${icon}${timestamp}${badge}<span class="log-message">${message}</span>`;
                return line;
            }

            function getTextNodes(node) {
                const textNodes = [];
                const walk = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null, false);
                let currentNode;
                while(currentNode = walk.nextNode()) {
                     if (currentNode.parentNode && currentNode.parentNode.nodeName !== 'SCRIPT' && currentNode.parentNode.nodeName !== 'STYLE') { // Checa parentNode
                          textNodes.push(currentNode);
                     }
                }
                return textNodes;
            }


            // --- Funções Auxiliares de UI ---

            function updateCounters() {
                let info = 0, success = 0, warning = 0, error = 0;
                allLogs.forEach(log => {
                    switch (log.level) {
                        case 'INFO': info++; break;
                        case 'SUCCESS': success++; break;
                        case 'WARNING': warning++; break;
                        case 'ERROR': error++; break;
                    }
                });
                countAll.textContent = allLogs.length;
                countInfo.textContent = info;
                countSuccess.textContent = success;
                countWarning.textContent = warning;
                countError.textContent = error;
            }

            function updateFooterStats(showingCount = null) {
                countShowing.textContent = showingCount !== null ? showingCount : logWindow.childElementCount;
                countTotal.textContent = allLogs.length;
            }


            function scrollToBottom() {
                 // Verifica se o usuário não rolou para cima manualmente
                 // Margem de erro de ~10 pixels
                const isScrolledToBottom = logWindow.scrollHeight - logWindow.clientHeight <= logWindow.scrollTop + 10;

                if (isAutoScroll || isScrolledToBottom) {
                    const lastLog = logWindow.lastElementChild;
                    if(lastLog) {
                         // Usar 'instant' pode ser melhor para logs rápidos
                         lastLog.scrollIntoView({ behavior: 'auto', block: 'end' });
                    }
                }
            }

            function getLevelIcon(level) {
                let svgClass = "log-icon";
                let svgContent = '';
                 switch (level) {
                    case 'INFO': svgContent = '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'; break;
                    case 'SUCCESS': svgContent = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'; break;
                    case 'WARNING': svgContent = '<path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'; break;
                    case 'ERROR': svgContent = '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'; break;
                    default: svgClass += " text-purple-400"; svgContent = '<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>';
                 }
                 return `<svg class="${svgClass}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${svgContent}</svg>`;
            }

            function getAccountBadge(account) {
                 if (!account) return '';
                 let baseColor = accountColors[account];
                 if (!baseColor) {
                      baseColor = colorPalette[colorIndex % colorPalette.length];
                      accountColors[account] = baseColor;
                      colorIndex++;
                 }

                 // --- INÍCIO DA MODIFICAÇÃO (Estilo v4) ---
                 // Define as cores
                 const backgroundColorRgba = hexToRgba(baseColor, 0.15); // Fundo 15% transparente
                 const lightColorHex = lightenHexColor(baseColor, 65); // Texto/Borda ~65% mais claro que baseColor

                 // Aplica os estilos inline
                 return `<span class="log-account-badge" style="background-color: ${backgroundColorRgba}; color: ${lightColorHex}; border-color: ${lightColorHex};">${escapeHTML(account)}</span>`;
                 // --- FIM DA MODIFICAÇÃO ---
            }

            function lightenHexColor(hex, percent) {
                if (!hex || typeof hex !== 'string' || !hex.startsWith('#') || (hex.length !== 7 && hex.length !== 4)) {
                    return '#CBD5E1'; // Cor slate-300 como fallback
                }
                 const fullHex = hex.length === 4 ? `#${hex[1]}${hex[1]}${hex[2]}${hex[2]}${hex[3]}${hex[3]}` : hex;

                let f = parseInt(fullHex.slice(1), 16),
                    t = percent < 0 ? 0 : 255,
                    // Garante que percent seja um número
                    p = (typeof percent === 'number' ? percent : 50),
                    R = f >> 16,
                    G = (f >> 8) & 0x00ff,
                    B = f & 0x0000ff;

                 // Ajusta p para clarear (0 a 100)
                 p = Math.max(0, Math.min(100, p < 0 ? p * -1 : p));

                return "#" + (
                    0x1000000 +
                    (Math.round(((t - R) * p) / 100) + R) * 0x10000 +
                    (Math.round(((t - G) * p) / 100) + G) * 0x100 +
                    (Math.round(((t - B) * p) / 100) + B)
                ).toString(16).slice(1).toUpperCase(); // Garante uppercase
            }

            function hexToRgba(hex, alpha = 1) {
                if (!hex || typeof hex !== 'string' || !hex.startsWith('#') || (hex.length !== 7 && hex.length !== 4)) {
                     // Cor cinza fallback mais escura
                     return `rgba(51, 65, 85, ${alpha})`; // Cor slate-700
                }
                const fullHex = hex.length === 4 ? `#${hex[1]}${hex[1]}${hex[2]}${hex[2]}${hex[3]}${hex[3]}` : hex;
                const bigint = parseInt(fullHex.slice(1), 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                // Garante que alpha esteja entre 0 e 1
                const validAlpha = Math.max(0, Math.min(1, alpha));
                return `rgba(${r}, ${g}, ${b}, ${validAlpha})`;
            }

            // --- Funções de Filtro ---
            function isLogVisible(log, searchTerm, selectedLevel, selectedAccount) {
                 if (!log) return false;
                const levelMatch = selectedLevel === 'ALL' || log.level === selectedLevel;
                const accountMatch = selectedAccount === 'ALL' || log.account === selectedAccount;
                const safeSearchTerm = searchTerm || '';
                const searchMatch = !safeSearchTerm ||
                                    (log.timestamp && log.timestamp.includes(safeSearchTerm)) ||
                                    (log.account && log.account.toLowerCase().includes(safeSearchTerm)) ||
                                    (log.message && log.message.toLowerCase().includes(safeSearchTerm));
                return levelMatch && accountMatch && searchMatch;
            }


            // --- Funções de Controle ---
            function toggleAutoScroll() {
                isAutoScroll = !isAutoScroll;
                autoScrollBtn.classList.toggle('active', isAutoScroll);
                if (isAutoScroll) {
                    scrollToBottom();
                }
            }

            function togglePause() {
                isPaused = !isPaused;
                pauseBtn.classList.toggle('active', isPaused);
                if (isPaused) {
                    pauseText.textContent = 'Retomar';
                    pauseIcon.style.display = 'none';
                    playIcon.style.display = 'inline-block';
                    statusText.textContent = 'Logs pausados.';
                    statusIndicator.classList.remove('active');
                    statusIndicator.classList.add('paused');
                } else {
                    pauseText.textContent = 'Pausar';
                    pauseIcon.style.display = 'inline-block';
                    playIcon.style.display = 'none';
                    statusText.textContent = 'Conectado. Logs ativos.';
                    statusIndicator.classList.add('active');
                    statusIndicator.classList.remove('paused');
                    renderLogs(); // Re-renderiza para aplicar logs que chegaram
                }
            }

            function clearLogs() {
                 // Limpa apenas o DOM
                if (confirm('Deseja limpar os logs visíveis na tela? (O histórico completo será mantido)')) {
                    logWindow.innerHTML = '';
                    updateFooterStats(0);
                    noResultsMsg.style.display = 'none';
                    // Re-renderiza com os filtros atuais (mostrará vazio ou "nenhum resultado")
                    renderLogs();
                }
            }

            function logToText(log) {
                 if (!log) return "";
                let message = log.message || "";
                if (log.is_html) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = message;
                    const preElement = tempDiv.querySelector('pre');
                    message = preElement ? (preElement.textContent || preElement.innerText || '') : (tempDiv.textContent || tempDiv.innerText || '');
                }
                 message = message.replace(/\s+/g, ' ').trim();
                return `[${log.timestamp || 'N/A'}] [${log.account || 'N/A'}] [${log.level || 'N/A'}] ${message}`;
            }

            function copyLogs() {
                const logsToCopyText = filteredLogs.map(logToText).join('\n'); // Usa filteredLogs (completo na memória)
                navigator.clipboard.writeText(logsToCopyText).then(() => {
                    alert(`${filteredLogs.length} logs filtrados copiados!`);
                }).catch(err => {
                    console.error('Falha ao copiar logs: ', err);
                    alert('Falha ao copiar logs. Verifique o console.');
                });
            }

            function downloadLogs() {
                const logsToDownloadText = filteredLogs.map(logToText).join('\n'); // Usa filteredLogs (completo na memória)
                const blob = new Blob([logsToDownloadText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.href = url;
                a.download = `kbot-logs-${timestamp}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // --- Funções de Utilidade ---
            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            function escapeRegExp(string) {
                 if (typeof string !== 'string') return '';
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // --- Bind de Eventos ---
            // Adiciona debounce ao input de busca para performance
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                 clearTimeout(searchTimeout);
                 searchTimeout = setTimeout(() => {
                      renderLogs();
                 }, 250); // Atraso de 250ms
            });
            //searchInput.addEventListener('input', renderLogs); // <-- Remove chamada direta
            levelFilter.addEventListener('change', renderLogs);
            accountFilter.addEventListener('change', renderLogs);

            autoScrollBtn.addEventListener('click', toggleAutoScroll);
            pauseBtn.addEventListener('click', togglePause);
            clearBtn.addEventListener('click', clearLogs);
            copyBtn.addEventListener('click', copyLogs);
            downloadBtn.addEventListener('click', downloadLogs);

             // Adiciona listener para desativar autoscroll se usuário rolar para cima
             logWindow.addEventListener('scroll', () => {
                 // Se o usuário rolou para cima e o autoscroll está ativo
                 if (logWindow.scrollTop < logWindow.scrollHeight - logWindow.clientHeight - 50 && isAutoScroll) {
                      isAutoScroll = false;
                      autoScrollBtn.classList.remove('active');
                 }
             });

            // Inicializa a UI (mostra vazio inicialmente, espera 'initial_logs')
            renderLogs();
        });


        // --- SCRIPT ORIGINAL DA PÁGINA ---
        const exchangesData = {{ exchanges_data | tojson | safe }};

        function toggleSetups(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (content) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    if (icon) icon.style.transform = 'rotate(0deg)';
                } else {
                    content.style.display = 'none';
                    if (icon) icon.style.transform = 'rotate(180deg)';
                }
            }
        }

        function resetSetupForm() {
            const form = document.getElementById('setup-form');
            if (!form) return;
            form.reset();
            if(form.querySelector('[name="risk"]')) form.querySelector('[name="risk"]').value = "1.0";
            if(form.querySelector('[name="leverage"]')) form.querySelector('[name="leverage"]').value = "10";
            if(form.querySelector('[name="sl_value"]')) form.querySelector('[name="sl_value"]').value = "2.0";
            if(form.querySelector('[name="rrr"]')) form.querySelector('[name="rrr"]').value = "2.0";
            if(form.querySelector('[name="direction_mode"]')) form.querySelector('[name="direction_mode"]').value = "long_short";
            if(form.querySelector('[name="exit_mode"]')) form.querySelector('[name="exit_mode"]').value = "passivo";
            if(form.querySelector('[name="tsl_type"]')) form.querySelector('[name="tsl_type"]').value = "none";
            toggleTslSection('passivo');
        }

        function hideSetupForm() {
            const section = document.getElementById('add-setup-form-section');
            if (section) section.style.display = 'none';
            resetSetupForm();
        }

        function showSetupForm(setupData) {
            const section = document.getElementById('add-setup-form-section');
            const form = document.getElementById('setup-form');
            if (!section || !form) return;
            resetSetupForm();
            if (setupData) { // Modo Editar
                form.querySelector('[name="account_name"]').value = setupData.account_name;
                form.querySelector('[name="base_currency"]').value = setupData.base_currency;
                form.querySelector('[name="risk"]').value = setupData.risk_per_trade * 100;
                form.querySelector('[name="leverage"]').value = setupData.leverage;
                form.querySelector('[name="direction_mode"]').value = setupData.direction_mode || 'long_short';
                form.querySelector('[name="strategy_name"]').value = setupData.strategy_name;
                form.querySelector('[name="rrr"]').value = setupData.take_profit_rrr;
                const slValueInput = form.querySelector('[name="sl_value"]');
                slValueInput.value = (setupData.stop_loss_config.type === 'percentage') ? setupData.stop_loss_config.value * 100 : setupData.stop_loss_config.value;
                const exitModeSelect = form.querySelector('[name="exit_mode"]');
                exitModeSelect.value = setupData.exit_mode;
                toggleTslSection(setupData.exit_mode);
                const tslConfig = setupData.trailing_stop_config;
                const tslTypeSelect = form.querySelector('[name="tsl_type"]');
                if (tslConfig && tslConfig.type !== 'none') {
                    tslTypeSelect.value = tslConfig.type;
                    if (tslConfig.type === 'breakeven' && form.querySelector('[name="tsl_breakeven_trigger"]')) {
                        form.querySelector('[name="tsl_breakeven_trigger"]').value = tslConfig.breakeven_trigger_rrr;
                    }
                    if (form.querySelector('[name="remove_tp_on_trail"]')) {
                        form.querySelector('[name="remove_tp_on_trail"]').checked = tslConfig.remove_tp_on_trail || false;
                    }
                } else if (tslTypeSelect) {
                    tslTypeSelect.value = 'none';
                }
                toggleTslOptions(tslTypeSelect ? tslTypeSelect.value : 'none');
            } else { // Modo Adicionar
                {% if accounts %}
                if (form.querySelector('[name="account_name"]')) {
                    form.querySelector('[name="account_name"]').value = "{{ accounts[0].account_name }}";
                }
                {% endif %}
            }
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => { alert("Endereço copiado!"); }, (err) => { alert("Falha ao copiar: ", err); });
        }

        function validateAccountForm() {
            const form = document.getElementById('account-form');
            if (!form) return false;
            const exchangeName = form.querySelector('[name="exchange_name"]').value;
            const originalAccountName = form.querySelector('[name="original_account_name"]').value;
            const exchange = exchangesData[exchangeName];
            if (exchange && !exchange.multi_account_allowed && exchange.accounts && exchange.accounts.length > 0) {
                if (!originalAccountName || (exchange.accounts[0] && exchange.accounts[0].account_name !== originalAccountName)) {
                    alert(`A exchange '${exchangeName}' não permite múltiplas contas. Você só pode editar a conta existente.`); return false;
                }
            }
            const requiredFields = form.querySelectorAll('[required]');
            for (let field of requiredFields) {
                if (field.offsetParent !== null && !field.value.trim()) {
                    alert(`O campo '${field.previousElementSibling?.textContent || field.name}' é obrigatório.`); field.focus(); return false;
                }
            }
            return true;
        }

        function toggleTslSection(exitMode) {
            const tslSection = document.getElementById('tsl-section');
            if (!tslSection) return;
            if (exitMode === 'ativo') {
                tslSection.style.display = 'flex';
            } else {
                tslSection.style.display = 'none';
                const tslTypeSelect = document.querySelector('select[name="tsl_type"]');
                if (tslTypeSelect) tslTypeSelect.value = 'none';
                toggleTslOptions('none');
            }
        }

        function toggleTslOptions(tslType) {
            const breakevenOptions = document.getElementById('tsl-breakeven-options');
            const atrOptions = document.getElementById('tsl-atr-options');
            const removeTpCheckboxLabel = document.querySelector('label[title*="Take Profit original"]');
            if (breakevenOptions) breakevenOptions.style.display = tslType === 'breakeven' ? 'flex' : 'none';
            if (atrOptions) atrOptions.style.display = tslType === 'atr' ? 'flex' : 'none';
            if (removeTpCheckboxLabel) { removeTpCheckboxLabel.style.display = (tslType !== 'none') ? 'flex' : 'none'; }
        }

        function togglePositionsTable() {
            const section = document.getElementById('positions-section');
            const icon = document.getElementById('positions-toggle-icon');
            if (!section || !icon) return;
            const isOpen = section.style.display === 'block';
            if (isOpen) {
                section.style.display = 'none';
                icon.classList.remove('open');
                icon.innerHTML = '<path d="m6 9 6 6 6-6"/>';
            } else {
                section.style.display = 'block';
                icon.classList.add('open');
                icon.innerHTML = '<path d="m18 15-6-6-6 6"/>';
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function toggleAddAccountForm(is_editing = false) {
            const section = document.getElementById('add-account-section');
            if (!section) return;
            if (section.style.display === 'none' || is_editing) {
                section.style.display = 'block';
                if(is_editing) { section.scrollIntoView({ behavior: 'smooth' }); }
            } else {
                section.style.display = 'none';
                resetAccountForm();
            }
        }

        function toggleNotificationsForm() {
            const section = document.getElementById('notifications-section');
            if (!section) return;
            if (section.style.display === 'none') {
                section.style.display = 'block';
                 section.scrollIntoView({ behavior: 'smooth' });
            } else {
                section.style.display = 'none';
            }
        }

        function resetAccountForm() {
            const form = document.getElementById('account-form');
            if (!form) return;
            form.reset();
            const title = document.getElementById('account-form-title');
            if (title) title.innerText = 'Adicionar Nova Conta';
            const originalNameInput = document.getElementById('original_account_name');
            if (originalNameInput) originalNameInput.value = '';
            const exchangeSelect = form.querySelector('select[name="exchange_name"]');
            if (exchangeSelect) {
                 exchangeSelect.selectedIndex = 0;
                 toggleCredentialFields(exchangeSelect.value);
            }
             form.querySelectorAll('input[type="password"]').forEach(input => input.value = '');
        }

        function toggleCredentialFields(exchangeName) {
            const pacificaFields = document.getElementById('pacifica-fields');
            const apexFields = document.getElementById('apex-fields');
            const pacificaInputs = document.querySelectorAll('.pacifica-required');
            const apexInputs = document.querySelectorAll('.apex-required');
            const isEditing = !!document.getElementById('original_account_name')?.value;

            if (pacificaFields) pacificaFields.style.display = exchangeName === 'pacifica' ? 'block' : 'none';
            if (apexFields) apexFields.style.display = exchangeName === 'apex' ? 'block' : 'none';

            pacificaInputs.forEach(input => { input.required = (exchangeName === 'pacifica') && (!isEditing || input.name === 'main_public_key'); });
            apexInputs.forEach(input => {
                 const isSecretField = ['api_secret', 'passphrase', 'zk_seeds', 'zk_l2key'].includes(input.name);
                 input.required = (exchangeName === 'apex') && (!isEditing || !isSecretField);
            });
        }

        function editAccount(accountData) {
            const form = document.getElementById('account-form');
            if (!form) return;
            resetAccountForm();
            const exchangeSelect = form.querySelector('[name="exchange_name"]');
            const title = document.getElementById('account-form-title');
            if (title) title.innerText = 'Editar Conta: ' + accountData.account_name;
            form.querySelector('[name="original_account_name"]').value = accountData.account_name;
            form.querySelector('[name="account_name"]').value = accountData.account_name;
            if (exchangeSelect) exchangeSelect.value = accountData.exchange_name;
            form.querySelector('[name="check_interval"]').value = accountData.check_interval_seconds;
            toggleCredentialFields(accountData.exchange_name);
            if (accountData.exchange_name === 'pacifica') {
                if(form.querySelector('[name="main_public_key"]')) form.querySelector('[name="main_public_key"]').value = accountData.main_public_key || '';
            } else if (accountData.exchange_name === 'apex') {
                if(form.querySelector('[name="api_key"]')) form.querySelector('[name="api_key"]').value = accountData.api_key || '';
            }
            toggleCredentialFields(accountData.exchange_name); // Re-aplica a lógica de required
            toggleAddAccountForm(true);
        }

        // --- DOMContentLoaded Original (Ajustado) ---
         document.addEventListener('DOMContentLoaded', () => {
            // Configuração inicial dos formulários e seções colapsáveis
            const accountFormExchangeSelect = document.querySelector('#account-form select[name="exchange_name"]');
            if (accountFormExchangeSelect) { toggleCredentialFields(accountFormExchangeSelect.value); }
            const setupFormExitSelect = document.querySelector('#setup-form select[name="exit_mode"]');
            if(setupFormExitSelect) {
                toggleTslSection(setupFormExitSelect.value);
                 const tslTypeSelect = document.querySelector('#setup-form select[name="tsl_type"]');
                 if(tslTypeSelect) { toggleTslOptions(tslTypeSelect.value); }
            }
            const positionsSection = document.getElementById('positions-section');
            if (positionsSection) positionsSection.style.display = 'none';
            const setupFormSection = document.getElementById('add-setup-form-section');
            if (setupFormSection) setupFormSection.style.display = 'none';
            document.querySelectorAll('[id^="setups-content-"]').forEach(el => el.style.display = 'none');
            document.querySelectorAll('[id^="setups-icon-"]').forEach(el => el.style.transform = 'rotate(180deg)');
            {% if backtest_result %}
                const setupForm = document.getElementById('add-setup-form-section');
                if (setupForm) {
                    setupForm.style.display = 'block';
                     const baseCurrencyInput = setupForm.querySelector('input[name="base_currency"]');
                     if (baseCurrencyInput && "{{ last_backtest_symbol }}") {
                         baseCurrencyInput.value = "{{ last_backtest_symbol }}".split('/')[0];
                     }
                    setupForm.scrollIntoView({ behavior: 'smooth' });
                }
            {% endif %}
             const positionsToggleIcon = document.getElementById('positions-toggle-icon');
             if (positionsToggleIcon) { positionsToggleIcon.innerHTML = '<path d="m6 9 6 6 6-6"/>'; }

             // *** A lógica de popular o filtro de logs JÁ ESTÁ no outro DOMContentLoaded ***
        });
    </script>
</body>
</html>